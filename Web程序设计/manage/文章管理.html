<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>文章管理</title>
    <style>
        .article-link:hover {
            color: #008aff;
            text-decoration: underline;
        }
    </style>
    <!-- ================= Favicon ================== -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- Styles -->
    <link href="assets/css/lib/calendar2/pignose.calendar.min.css" rel="stylesheet">
    <link href="assets/css/lib/font-awesome.min.css" rel="stylesheet">
    <link href="assets/css/lib/themify-icons.css" rel="stylesheet">
    <link href="assets/css/lib/menubar/sidebar.css" rel="stylesheet">
    <link href="assets/css/lib/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/lib/unix.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
</head>

<body>

    <div class="sidebar sidebar-hide-to-small sidebar-shrink sidebar-gestures">
        <div class="nano">
            <div class="nano-content">
                <ul>
                    <li class="label">主页面</li>
                    <li class="active"><a class="sidebar-sub-toggle"><i class="ti-home"></i> 平台管理 <span
                                class="sidebar-collapse-icon ti-angle-down"></span></a>
                        <ul>
                            <li><a href="index.html">Dashboard 1</a></li>
                            <li><a href="index-v1.html">Dashboard 2</a></li>
                            <li><a href="index-school.html">Dashboard 3</a></li>
                            <li><a href="index-restaurant.html">Dashboard 4</a></li>
                        </ul>
                    </li>
                    <li class="label">管理</li>
                    <li><a class="sidebar-sub-toggle"><i class="ti-pencil-alt"></i>管理界面 <span
                                class="badge badge-primary">3</span><span
                                class="sidebar-collapse-icon ti-angle-down"></span></a>
                        <ul>
                            <li><a href="#" data-page="用户管理.html">用户管理</a></li>
                            <li><a href="#" data-page="文章管理.html">文章管理</a></li>
                            <li><a href="#" data-page="评论管理.html">评论管理</a></li>
                        </ul>
                    </li>

                    <li class="label">数据统计</li>
                    <li><a class="sidebar-sub-toggle"><i class="ti-cup"></i> 数据统计<span
                                class="badge badge-primary">7</span> <span
                                class="sidebar-collapse-icon ti-angle-down"></span></a>
                        <ul>
                            <li><a href="restaurant-menu-one.html">Menu One</a></li>
                            <li><a href="restaurant-menu-two.html">Menu Two</a></li>
                            <li><a href="restaurant-menu-three.html">Menu Three</a></li>
                            <li><a href="restaurant-favourite-list.html">Favourite</a></li>
                            <li><a href="restaurant-order-list.html">Order List</a></li>
                            <li><a href="restaurant-booking.html">Booking</a></li>
                            <li><a href="restaurant-upload-menu.html">Upload Menu</a></li>
                        </ul>
                    </li>



            </div>
        </div>
    </div>
    <!-- /# sidebar -->

    <div class="header">
        <div class="pull-left">
            <div class="logo"><a href="index.html"><span>文章管理系统后台页面</span></a></div>
            <div class="hamburger sidebar-toggle">
                <span class="line"></span>
                <span class="line"></span>
                <span class="line"></span>
            </div>
        </div>
        <div class="pull-right p-r-15">
            <ul>
                <li class="header-icon dib"><a href="#search"><i class="ti-search"></i></a></li>
                <li class="header-icon dib"><img class="avatar-img" src="assets/images/avatar/1.jpg" alt="" /> <span
                        class="user-avatar">{{用户名}} <i class="ti-angle-down f-s-10"></i></span>
                    <div class="drop-down dropdown-profile">
                        <div class="dropdown-content-body">
                            <ul>
                                <li><a href="#"><i class="ti-calendar"></i> <span>预留接口</span></a></li>
                                <li><a href="#"><i class="ti-settings"></i> <span>设置</span></a></li>
                                <li><a href="#"><i class="ti-help-alt"></i> <span>帮助</span></a></li>
                                <li><a href="#"><i class="ti-lock"></i> <span>密码修改</span></a></li>
                                <li><a href="../index.html"><i class="ti-power-off"></i> <span>退出</span></a></li>
                            </ul>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <div class="content-wrap">
        <div class="main">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-8 p-r-0 title-margin-right">
                        <div class="page-header">
                            <div class="page-title">
                                <h1>主页面</h1>
                            </div>
                        </div>
                    </div>
                    <!-- /# column -->
                    <div class="col-lg-4 p-l-0 title-margin-left">
                        <div class="page-header">
                            <div class="page-title">
                                <ol class="breadcrumb text-right">
                                    <li>
                                        <a href="#" data-page="index.html">主页面</a>
                                    </li>
                                    <li class="active">文章管理</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <!-- /# column -->
                </div>
                <!-- /# row -->
                <section id="main-content">
                    <div class="row" style="width: 100%;">
                        <div class="col-lg-9" style="width: 100%;">
                            <div class="card alert" style="width: 100%;">
                                <div class="card-header pr">
                                    <h4>用户列表</h4>
                                    <div class="search-action">
                                        <div class="search-type dib" style="display: flex;">
                                            <input id="searchInput" class="form-control input-rounded"
                                                placeholder="search" type="text">
                                            <i id="searchIcon" class="ti-search"
                                                style="margin-left: 5px;line-height: 32px;"></i>
                                        </div>
                                    </div>

                                    <div class="card-header-right-icon">
                                        <ul>
                                            <li class="card-close" data-dismiss="alert"><i class="ti-close"></i></li>
                                            <li class="card-option drop-menu"><i class="ti-settings"
                                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"
                                                    role="link"></i>
                                                <ul class="card-option-dropdown dropdown-menu">
                                                    <li><a href="#"><i class="ti-loop"></i> 更新数据</a></li>
                                                    <li><a href="#"><i class="ti-menu-alt"></i> 详情</a></li>
                                                    <li><a href="#"><i class="ti-pulse"></i> Statistics</a></li>
                                                    <li><a href="#"><i class="ti-power-off"></i> Clear ist</a></li>
                                                </ul>
                                            </li>
                                            <li class="doc-link"><a href="#"><i class="ti-link"></i></a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table student-data-table m-t-20">
                                            <thead>
                                                <tr>
                                                    <th>文章id</th>
                                                    <th>一级标题</th>
                                                    <th>二级标题</th>
                                                    <th>标题</th>
                                                    <th>作者</th>
                                                    <th>发表时间</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            <tbody id="userTableBody"></tbody>

                                            </tbody>

                                        </table>
                                        <nav aria-label="Page navigation example" style="float: right;">
                                            <ul class="pagination">
                                                <li class="page-item">
                                                    <a class="page-link" href="#" aria-label="Previous">
                                                        <span aria-hidden="true">&laquo;</span>
                                                    </a>
                                                </li>
                                                <li class="page-item"><a class="page-link" href="#">1</a></li>
                                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                                <li class="page-item">
                                                    <a class="page-link" href="#" aria-label="Next">
                                                        <span aria-hidden="true">&raquo;</span>
                                                    </a>
                                                </li>
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- /# column -->

                    </div>
                    <!-- /# row -->

                    <div class="row">
                        <div class="col-lg-12">
                            <div class="footer">
                                <p>此仪表板生成于 <span id="date-time"></span> <a href="#" class="page-refresh">更新面板</a></p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>






    <div id="search">
        <button type="button" class="close">×</button>
        <form>
            <input type="search" value="" placeholder="type keyword(s) here" />
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
    </div>
    <!-- jquery vendor -->
    <script src="assets/js/lib/jquery.min.js"></script>
    <script src="assets/js/lib/jquery.nanoscroller.min.js"></script>
    <!-- nano scroller -->
    <script src="assets/js/lib/menubar/sidebar.js"></script>
    <script src="assets/js/lib/preloader/pace.min.js"></script>
    <!-- sidebar -->
    <script src="assets/js/lib/bootstrap.min.js"></script>
    <!-- bootstrap -->
    <script src="assets/js/lib/calendar-2/moment.latest.min.js"></script>
    <!-- scripit init-->
    <script src="assets/js/lib/calendar-2/semantic.ui.min.js"></script>
    <!-- scripit init-->
    <script src="assets/js/lib/calendar-2/prism.min.js"></script>
    <!-- scripit init-->
    <script src="assets/js/lib/calendar-2/pignose.calendar.min.js"></script>
    <!-- scripit init-->
    <script src="assets/js/lib/calendar-2/pignose.init.js"></script>
    <script src="assets/js/scripts.js"></script>
    <!-- scripit init-->
    <script>
        var userId;
        // 定义每页显示的用户数量
        var pageSize = 10;

        // 当前页数
        var currentPage = 1;

        // 总页数
        var totalPages = 0;

        // 刷新表格函数
        function refreshTable() {
            // 发送获取文章列表的请求
            $.ajax({
                type: "GET",
                url: "http://127.0.0.1:5000/get_articles",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if (data.status === '200') {
                        // 更新页面内容
                        updateTable(data.articles);
                    } else {
                        console.error('获取文章列表失败:', data.error);
                    }
                },
                error: function (error) {
                    console.error('请求错误:', error);
                }
            });
        }




        // 更新表格内容
        function updateTable(articles) {
            // 清空表格内容
            $("#userTableBody").empty();
            // 计算总页数
            totalPages = Math.ceil(articles.length / pageSize);
            // 根据当前页数和每页数量计算要显示的用户数据范围
            var startIndex = (currentPage - 1) * pageSize;
            var endIndex = Math.min(startIndex + pageSize, articles.length);

            for (var i = startIndex; i < endIndex; i++) {
                var article = articles[i];
                let articleTitleHTML = "<a class='article-link' href='文章管理详情.html?article_id=" + article.article_id + "&user_id="+userId+"'>" + article.title + "</a>";
                let newRow = "<tr>" +
                    "<td>" + article.article_id + "</td>" +
                    "<td>" + article.title1 + "</td>" +
                    "<td>" + article.title2 + "</td>" +
                    "<td>" + articleTitleHTML + "</td>" +
                    "<td>" + article.author + "</td>" +
                    "<td>" + article.creat_time + "</td>" +
                    "<td>" +
                    "<span class='deleteButton' data-article-id='" + article.article_id + "'><a href='#'><i class='ti-trash color-danger'></i></a></span>" +
                    "</td>" +
                    "</tr>";

                // 将新行追加到表格体
                $("#userTableBody").append(newRow);
            }

            // 更新分页导航
            updatePagination();
        }

        // 更新分页导航
        function updatePagination() {
            // 清空分页导航
            $(".pagination").empty();

            // 添加上一页按钮
            $(".pagination").append('<li class="page-item"><a class="page-link" href="#" onclick="prevPage()">上一页</a></li>');

            // 添加页数按钮
            for (var i = 1; i <= totalPages; i++) {
                $(".pagination").append('<li class="page-item"><a class="page-link" href="#" onclick="gotoPage(' + i + ')">' + i + '</a></li>');
            }

            // 添加下一页按钮
            $(".pagination").append('<li class="page-item"><a class="page-link" href="#" onclick="nextPage()">下一页</a></li>');
        }

        // 上一页
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                refreshTable();
            }
        }

        // 下一页
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                refreshTable();
            }
        }

        // 跳转到指定页
        function gotoPage(page) {
            currentPage = page;
            refreshTable();
        }

        // 在页面加载时调用刷新表格函数
        $(document).ready(function () {
            refreshTable();
        });

        //删除文章
        $(document).ready(function () {
            // 或者使用以下语法
            // $(function() {
            //删除文章
            $('#userTableBody').on('click', '.deleteButton', function () {
                var id = $(this).data('article-id'); // 使用 $(this) 获取点击的按钮
                $.ajax({
                    type: 'POST',
                    url: 'http://127.0.0.1:5000/delete_blog',
                    data: JSON.stringify({ blog_id: id }),
                    contentType: 'application/json; charset=utf-8',
                    success: function (response) {
                        if (response.status == '200') {
                            alert("删除成功");
                            refreshTable();
                        } else {
                            alert("没有该文章");
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error("AJAX request failed: " + textStatus, errorThrown);
                        console.log(jqXHR.responseText);
                    }
                });
            });

            $("#searchIcon").click(function () {
                var searchTerm = $("#searchInput").val();

                // 刷新表格函数
                function likeRefreshTable() {
                    // 获取搜索关键字
                    var searchKeyword = $(".search-type input").val();

                    // 发送获取用户列表的请求
                    $.ajax({
                        type: "POST",
                        url: "http://127.0.0.1:5000/get_like_articles",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: JSON.stringify({ search: searchKeyword }),  // Send JSON data
                        success: function (response) {
                            if (response.status == "200") {
                                // 更新页面内容
                                updateTable(response.articles);
                            } else {
                                console.error('获取文章列表失败:', data.error);
                            }
                        },
                        error: function (error) {
                            console.error('请求错误:', error);
                        }
                    });
                }
                likeRefreshTable();
                $("#searchInput").val('')
            });


            function getUserInfo() {
                var url = window.location.href;
                var params = url.split('?')[1];
                var keyValuePairs;

                if (params) {
                    keyValuePairs = params.split('&');
                    var paramsObject = {};
                    for (var i = 0; i < keyValuePairs.length; i++) {
                        var pair = keyValuePairs[i].split('=');
                        paramsObject[pair[0]] = pair[1];
                    }

                    userId = paramsObject['id'];

                    if (!userId) {
                        window.location.href = "../Template/html/login.html";
                    } else {
                        $.ajax({
                            type: "POST",
                            url: "http://127.0.0.1:5000/get_user",
                            data: JSON.stringify({ user_id: userId }),
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            success: function (data) {
                                if (data.status === '200') {
                                    $(".user-avatar").text(data.username + ' ');
                                } else {
                                    console.error('获取用户信息失败:', data.error);
                                }
                            },
                            error: function (error) {
                                console.error('请求错误:', error);
                            }
                        });

                        // 返回一个函数，该函数接受 page 参数并重定向到该页面
                        return function redirectToPage(page) {
                            window.location.href = page + '?id=' + userId;
                        };
                    }
                } else {
                    window.location.href = "../Template/html/login.html";
                }
            }

            // 获取 redirectToPage 函数
            var redirectToPage = getUserInfo();

            // 处理点击事件，确保 data-page 属性包含目标页面
            $(document).on('click', 'a[data-page]', function (event) {
                event.preventDefault();
                var page = $(this).data('page');
                redirectToPage(page); // 不再传递 userId，因为已经在 getUserInfo 中获取
            });

            // 调用 getUserInfo 获取用户信息并设置页面状态
            getUserInfo();
        });
    </script>
</body>

</html>